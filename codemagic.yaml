workflows:
  ios-release:
    name: iOS Release Build
    environment:
      flutter: stable            # يمنع إعادة تحميل Flutter كل مرة

      groups:
        - ios_credentials

      vars:
        FIREBASE_APP_ID: "1-563950462964-ios-a42d70b510fffff032bba1"
        FIREBASE_PROJECT_ID: "clubnotification-c0a25"
        GOOGLE_APPLICATION_CREDENTIALS_JSON: Encrypted(GOOGLE_APPLICATION_CREDENTIALS_JSON)

    cache:
      cache_default_paths: true
      cache_paths:
        - $HOME/.pub-cache
        - ios/Pods
        - $HOME/Library/Caches/CocoaPods
        - $FLUTTER_ROOT/bin/cache
        - build/

    scripts:
      # 1. تثبيت Firebase CLI (مرة واحدة فقط)
      - name: Install Firebase CLI
        script: |
          if ! command -v firebase &> /dev/null; then
            echo "Installing Firebase CLI..."
            curl -sL https://firebase.tools | bash
          else
            echo "Firebase CLI already installed."
          fi

      # 2. تثبيت Flutter dependencies
      - name: Install Flutter dependencies
        script: |
          flutter pub get

      # 3. تسريع CocoaPods عبر caching
      - name: Install iOS Pods
        script: |
          cd ios
          pod install --repo-update
          cd ..

      # 4. التحقق من قدرات iOS
      - name: Verify iOS Capabilities
        script: |
          echo "Checking Push Notifications capability..."
          if ! plutil -p ios/Runner/Info.plist | grep -q "aps-environment"; then
            echo "⚠️ Push Notifications capability not set in Info.plist"
            exit 1
          fi
          echo "✅ Push Notifications capability found"

          echo "Checking Background Modes (remote-notification)..."
          if ! plutil -p ios/Runner/Info.plist | grep -q "remote-notification"; then
            echo "⚠️ Background Modes (remote-notification) not set"
            exit 1
          fi
          echo "✅ Background Modes capability found"

      # 5. بناء IPA نسخة release
      - name: Build IPA
        script: |
          flutter build ipa --release
          IPA_PATH="build/ios/ipa/Runner.ipa"
          if [ ! -f "$IPA_PATH" ]; then
            echo "❌ IPA file not found at $IPA_PATH"
            exit 1
          fi
          echo "✅ IPA built at $IPA_PATH"

      # 6. رفع التطبيق إلى Firebase App Distribution
      - name: Upload to Firebase App Distribution
        script: |
          echo "Setting up Firebase Service Account..."
          echo "$GOOGLE_APPLICATION_CREDENTIALS_JSON" > service-account.json
          export GOOGLE_APPLICATION_CREDENTIALS="$(pwd)/service-account.json"

          echo "Uploading IPA to Firebase..."
          firebase appdistribution:distribute "$IPA_PATH" \
            --app "$FIREBASE_APP_ID" \
            --project "$FIREBASE_PROJECT_ID" \
            --release-notes "iOS Test Release" \
            --groups "clubIos"
